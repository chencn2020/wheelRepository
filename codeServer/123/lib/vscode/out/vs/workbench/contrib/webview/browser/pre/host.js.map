{"version":3,"sources":["vs/workbench/contrib/webview/browser/pre/host.js"],"names":["id","document","location","search","match","hostMessaging","[object Object]","this","handlers","Map","window","addEventListener","e","data","command","postMessage","channel","handler","get","args","console","log","parent","target","set","workerReady","Promise","async","resolveWorkerReady","navigator","serviceWorker","areServiceWorkersEnabled","register","then","ready","versionHandler","event","removeEventListener","version","registration","update","finally","active","forwardFromHostToWorker","onMessage","includes","createWebviewManager","bind","fakeLoad"],"mappings":";;;;CAKC,WACA,MAAMA,EAAKC,SAASC,SAASC,OAAOC,MAAM,iBAAiB,GAErDC,EAAgB,IAAI,MACzBC,cACCC,KAAKC,SAAW,IAAIC,IACpBC,OAAOC,iBAAiB,UAAYC,IACnC,GAAIA,EAAEC,OAA4B,cAAnBD,EAAEC,KAAKC,SAA8C,oBAAnBF,EAAEC,KAAKC,SAGvD,YADAP,KAAKQ,YAAYH,EAAEC,KAAKC,QAASF,EAAEC,KAAKA,MAIzC,MAAMG,EAAUJ,EAAEC,KAAKG,QACjBC,EAAUV,KAAKC,SAASU,IAAIF,GAC9BC,EACHA,EAAQL,EAAGA,EAAEC,KAAKM,MAElBC,QAAQC,IAAI,kBAAmBT,KAKlCN,YAAYU,EAASH,GACpBH,OAAOY,OAAOP,YAAY,CAAEQ,OAAQvB,EAAIgB,QAAAA,EAASH,KAAAA,GAAQ,KAG1DP,UAAUU,EAASC,GAClBV,KAAKC,SAASgB,IAAIR,EAASC,KAIvBQ,EAAc,IAAIC,QAAQC,MAAOC,IACtC,IA8CD,WACC,IACC,QAASC,UAAUC,cAClB,MAAOlB,GACR,OAAO,GAlDHmB,GAEJ,OADAX,QAAQC,IAAI,oEACLO,IAKRC,UAAUC,cAAcE,SAAS,qBAAqBC,KAAKN,MAAAA,UACpDE,UAAUC,cAAcI,MAE9B,MAAMC,EAAkBC,IACvB,GAA2B,YAAvBA,EAAMvB,KAAKG,QAKf,OADAa,UAAUC,cAAcO,oBAAoB,UAAWF,GAV3B,IAWxBC,EAAMvB,KAAKyB,QACPV,IAGAW,EAAaC,SAClBP,KAAK,IAAMJ,UAAUC,cAAcI,OACnCO,QAAQb;CAGZC,UAAUC,cAAcnB,iBAAiB,UAAWwB,GACpDI,EAAaG,OAAO3B,YAAY,CAAEC,QAAS,cAG5C,MAAM2B,EAA2B3B,IAChCX,EAAcuC,UAAU5B,EAASoB,IAChCP,UAAUC,cAAcI,MAAMD,KAAKM,IAClCA,EAAaG,OAAO3B,YAAY,CAAEC,QAASA,EAASH,KAAMuB,EAAMvB,KAAKM,YAIxEwB,EAAwB,qBACxBA,EAAwB,sBAExBd,UAAUC,cAAcnB,iBAAiB,UAAWyB,IAC/C,CAAC,gBAAiB,kBAAkBS,SAAST,EAAMvB,KAAKG,UAC3DX,EAAcU,YAAYqB,EAAMvB,KAAKG,QAASoB,EAAMvB,UAavDH,OAAOoC,qBAAqB,CAC3B/B,YAAaV,EAAcU,YAAYgC,KAAK1C,GAC5CuC,UAAWvC,EAAcuC,UAAUG,KAAK1C,GACxC6B,MAAOT,EACPuB,UAAU,IA3FZ","file":"host.js","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n// @ts-check\n(function () {\n\tconst id = document.location.search.match(/\\bid=([\\w-]+)/)[1];\n\n\tconst hostMessaging = new class HostMessaging {\n\t\tconstructor() {\n\t\t\tthis.handlers = new Map();\n\t\t\twindow.addEventListener('message', (e) => {\n\t\t\t\tif (e.data && (e.data.command === 'onmessage' || e.data.command === 'do-update-state')) {\n\t\t\t\t\t// Came from inner iframe\n\t\t\t\t\tthis.postMessage(e.data.command, e.data.data);\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tconst channel = e.data.channel;\n\t\t\t\tconst handler = this.handlers.get(channel);\n\t\t\t\tif (handler) {\n\t\t\t\t\thandler(e, e.data.args);\n\t\t\t\t} else {\n\t\t\t\t\tconsole.log('no handler for ', e);\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\n\t\tpostMessage(channel, data) {\n\t\t\twindow.parent.postMessage({ target: id, channel, data }, '*');\n\t\t}\n\n\t\tonMessage(channel, handler) {\n\t\t\tthis.handlers.set(channel, handler);\n\t\t}\n\t}();\n\n\tconst workerReady = new Promise(async (resolveWorkerReady) => {\n\t\tif (!areServiceWorkersEnabled()) {\n\t\t\tconsole.log('Service Workers are not enabled. Webviews will not work properly');\n\t\t\treturn resolveWorkerReady();\n\t\t}\n\n\t\tconst expectedWorkerVersion = 1;\n\n\t\tnavigator.serviceWorker.register('service-worker.js').then(async registration => {\n\t\t\tawait navigator.serviceWorker.ready;\n\n\t\t\tconst versionHandler = (event) => {\n\t\t\t\tif (event.data.channel !== 'version') {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tnavigator.serviceWorker.removeEventListener('message', versionHandler);\n\t\t\t\tif (event.data.version === expectedWorkerVersion) {\n\t\t\t\t\treturn resolveWorkerReady();\n\t\t\t\t} else {\n\t\t\t\t\t// If we have the wrong version, try once to unregister and re-register\n\t\t\t\t\treturn registration.update()\n\t\t\t\t\t\t.then(() => navigator.serviceWorker.ready)\n\t\t\t\t\t\t.finally(resolveWorkerReady);\n\t\t\t\t}\n\t\t\t};\n\t\t\tnavigator.serviceWorker.addEventListener('message', versionHandler);\n\t\t\tregistration.active.postMessage({ channel: 'version' });\n\t\t});\n\n\t\tconst forwardFromHostToWorker = (channel) => {\n\t\t\thostMessaging.onMessage(channel, event => {\n\t\t\t\tnavigator.serviceWorker.ready.then(registration => {\n\t\t\t\t\tregistration.active.postMessage({ channel: channel, data: event.data.args });\n\t\t\t\t});\n\t\t\t});\n\t\t};\n\t\tforwardFromHostToWorker('did-load-resource');\n\t\tforwardFromHostToWorker('did-load-localhost');\n\n\t\tnavigator.serviceWorker.addEventListener('message', event => {\n\t\t\tif (['load-resource', 'load-localhost'].includes(event.data.channel)) {\n\t\t\t\thostMessaging.postMessage(event.data.channel, event.data);\n\t\t\t}\n\t\t});\n\t});\n\n\tfunction areServiceWorkersEnabled() {\n\t\ttry {\n\t\t\treturn !!navigator.serviceWorker;\n\t\t} catch (e) {\n\t\t\treturn false;\n\t\t}\n\t}\n\n\twindow.createWebviewManager({\n\t\tpostMessage: hostMessaging.postMessage.bind(hostMessaging),\n\t\tonMessage: hostMessaging.onMessage.bind(hostMessaging),\n\t\tready: workerReady,\n\t\tfakeLoad: true\n\t});\n}());"]}